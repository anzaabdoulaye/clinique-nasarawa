{# templates/utilisateur/param.html.twig (ou templates/param/index.html.twig) #}
{% extends 'base.html.twig' %}

{% block title %}Paramètres{% endblock %}

{% block body %}
<div class="row">
  <div class="col-xl-3 col-md-6">
    <div class="card card-animate">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="flex-grow-1 overflow-hidden">
            <p class="text-uppercase fw-medium text-muted text-truncate mb-0">
              Services Médicaux
            </p>
          </div>
          <div class="flex-shrink-0">
            <h5 class="text-success fs-14 mb-0">
              <i class="ri-settings-3-line fs-13 align-middle"></i>
            </h5>
          </div>
        </div>

        <div class="d-flex align-items-end justify-content-between mt-4">
          <div>
            <h4 class="fs-22 fw-semibold ff-secondary mb-2">
              {{ servicesCount|default(0) }}
            </h4>

            <div class="d-flex gap-2 flex-wrap">
              <button type="button"
                      class="btn btn-sm btn-success"
                      data-bs-toggle="modal"
                      data-bs-target="#addServiceMedicalModal">
                <i class="ri-add-line"></i> Ajouter
              </button>

              <a href="{{ path('app_service_medical_index') }}"
                 class="btn btn-sm btn-outline-primary">
                <i class="ri-list-check"></i> Gérer
              </a>
            </div>
          </div>

          <div class="avatar-sm flex-shrink-0">
            <span class="avatar-title bg-success-subtle rounded fs-3">
              <i class="ri-hospital-line text-success"></i>
            </span>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

{# MODAL AJOUT SERVICE MEDICAL (AJAX) #}
<div class="modal fade" id="addServiceMedicalModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Nouveau Service Médical</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body" id="addServiceMedicalBody">
        {# ✅ On rend directement le form (pas de fetch GET) #}
        {{ form_start(serviceForm, {'attr': {'id': 'ServiceMedicalForm'}}) }}

          <div class="row g-3">
            <div class="col-md-12">
              {{ form_row(serviceForm.libelle) }}
            </div>
          </div>

          <div class="d-flex justify-content-end mt-4 gap-2">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuler</button>
            <button type="submit" class="btn btn-success">Enregistrer</button>
          </div>

        {{ form_end(serviceForm) }}
      </div>

    </div>
  </div>
</div>
{% endblock %}

{% block javascripts %}
  {{ parent() }}
  <script>
    (function () {
      const modalEl = document.getElementById('addServiceMedicalModal');
      if (!modalEl) return;

      const modalBody = document.getElementById('addServiceMedicalBody');

      function bindAjaxSubmit() {
        const form = modalBody.querySelector('form#ServiceMedicalForm');
        if (!form) return;

        // ✅ éviter double binding si tu réinjectes le HTML du form
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          e.stopPropagation();

          const url = form.getAttribute('action'); // ✅ action = app_service_medical_create_ajax (défini dans ton controller)
          const formData = new FormData(form);

          const res = await fetch(url, {
            method: 'POST',
            body: formData,
            headers: {
              'X-Requested-With': 'XMLHttpRequest',
              'Accept': 'application/json'
            }
          });

          const json = await res.json();

          if (json.success) {
            bootstrap.Modal.getInstance(modalEl).hide();
            window.location.reload();
            return;
          }

          // ✅ erreurs => remplacer le contenu du modal par le HTML renvoyé
          if (json.html) {
            modalBody.innerHTML = json.html;
            bindAjaxSubmit(); // re-bind sur le nouveau form
          } else {
            modalBody.insertAdjacentHTML(
              'afterbegin',
              '<div class="alert alert-danger mb-3">Formulaire invalide.</div>'
            );
          }
        }, { once: true });
      }

      // bind dès le chargement
      bindAjaxSubmit();

      // optionnel : rebind à chaque ouverture (utile si tu réinjectes html)
      modalEl.addEventListener('shown.bs.modal', () => {
        bindAjaxSubmit();
      });
    })();
  </script>
{% endblock %}